---
import Layout from "@layouts/Layout.astro";
import { getCollection } from "astro:content";
import Posts from "@components/Posts.astro";
import { Icon } from "astro-icon/components";

// Get all changelog posts
const allPosts = await getCollection("blogPosts");
const changelogPosts = allPosts
  .filter(
    (post) => post.data.categories?.includes("changelog") && !post.data.isDraft
  )
  .sort(
    (a, b) =>
      (b.data.createdAt?.getTime() ?? 0) - (a.data.createdAt?.getTime() ?? 0)
  );

// Get changelog category description
const changelogCategory = await getCollection("blogCategories").then((cats) =>
  cats.find((cat) => cat.id === "changelog")
);
---

<Layout
  title="Changelog - Patron"
  ogDescription={changelogCategory?.data.description ||
    "Stay up to date with the latest features, improvements, and fixes to the Patron platform."}
>
  <section
    class="bg-green cube-bg px-base mx-auto pt-[150px] pb-[80px] sm:pt-[200px] sm:pb-[160px]"
  >
    <div class="container-content flex flex-col gap-10">
      <div class="flex flex-col gap-4">
        <div class="flex items-center justify-between">
          <h1>Changelog</h1>
          <a
            href="/changelog/rss.xml"
            class="flex items-center gap-2 fill-black text-sm text-black"
            title="Subscribe to changelog RSS feed"
          >
            <Icon name="simple-icons:rss" class="h-6 w-6" />
          </a>
        </div>
        <p class="text-lg">
          {changelogCategory?.data.description}
        </p>

        <Posts posts={changelogPosts} />

        {
          changelogPosts.length === 0 && (
            <div class="py-10 text-center text-gray-500">
              <p>No changelog entries found.</p>
            </div>
          )
        }
      </div>
    </div>
  </section>
</Layout>
